<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙串口调试工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 12px;
        }

        /* 全局字体大小统一 */
        input, button, label, span, div {
            font-size: 12px !important;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 5px;
        }

        /* 顶部连接区域 */
        .connection-panel {
            background-color: #2d2d30;
            /* padding: 5px; */
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .connection-left {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
        }

        .connection-left input{
            width: 100px;
        }

        .connection-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .connection-panel input {
            padding: 5px 5px;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-size: 12px;
        }

        .connection-panel button {
            padding: 5px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .connect-btn {
            background-color: #0e639c;
            color: white;
        }

        .connect-btn:hover {
            background-color: #1177bb;
        }

        .connect-btn:disabled {
            background-color: #3c3c3c;
            cursor: not-allowed;
        }

        .disconnect-btn {
            background-color: #e74c3c;
            color: white;
        }

        .disconnect-btn:hover {
            background-color: #c0392b;
        }

        .status-info {
            color: #4ec9b0;
            font-size: 12px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 12px;
            height: 12px;
        }

        /* 中间接收区域 */
        .receive-panel {
            flex: 1;
            background-color: #2d2d30;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .receive-header {
            /* padding: 5px; */
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .receive-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .receive-output {
            flex: 1;
            padding: 5px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            /* line-height: 1.4; */
            background-color: #1e1e1e;
            color: #d4d4d4;
            white-space: pre;
            overflow-x: auto;
            word-break: normal;
        }

        .receive-output::-webkit-scrollbar {
            width: 5px;
        }

        .receive-output::-webkit-scrollbar-track {
            background: #2d2d30;
        }

        .receive-output::-webkit-scrollbar-thumb {
            background: #6b6b6b;
            border-radius: 4px;
        }

        .receive-output::-webkit-scrollbar-thumb:hover {
            background: #8b8b8b;
        }

        .clear-btn {
            padding: 5px 15px;
            background-color: #6b6b6b;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-btn:hover {
            background-color: #8b8b8b;
        }

        /* 底部发送区域 */
        .send-panel {
            background-color: #2d2d30;
            /* padding: 5px; */
            border-radius: 5px;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .send-input {
            flex: 1;
            padding: 5px 12px;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-size: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .send-btn {
            padding: 5px 15px;
            background-color: #0e639c;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            background-color: #1177bb;
        }

        .send-btn:disabled {
            background-color: #3c3c3c;
            cursor: not-allowed;
        }

        /* 自定义按键区域 */
        .custom-buttons-panel {
            background-color: #2d2d30;
            /* padding: 5px; */
            border-radius: 5px;
            margin-top: 5px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            align-items: center;
        }

        .custom-btn {
            padding: 6px 12px;
            background-color: #4a4a4a;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .custom-btn:hover:not(:disabled) {
            background-color: #5a5a5a;
        }

        .custom-btn:disabled {
            background-color: #3c3c3c;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            .container {
                padding: 5px;
            }
            
            .connection-panel {
                padding: 5px;
                gap: 5px;
            }
            
            .connection-panel input {
                font-size: 12px;
                padding: 4px 5px;
            }
            
            .connection-panel button {
                font-size: 12px;
                padding: 4px 12px;
            }
            
            .receive-output {
                font-size: 12px;
                padding: 5px;
            }
            
            .send-panel {
                padding: 5px;
                gap: 5px;
            }
            
            .send-input {
                font-size: 12px;
                padding: 6px 5px;
            }
            
            .send-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* Web端样式 - 当屏幕宽度较大时使用更小的字体 */
        @media (min-width: 601px) {
            .receive-output {
                font-size: 10px;
            }
        }
        
        /* 颜色转义字符样式 */
        .ansi-bold { font-weight: bold; }
        .ansi-black { color: black; }
        .ansi-red { color: red; }
        .ansi-green { color: green; }
        .ansi-yellow { color: yellow; }
        .ansi-blue { color: blue; }
        .ansi-magenta { color: magenta; }
        .ansi-cyan { color: cyan; }
        .ansi-white { color: white; }
        
        .ansi-bg-black { background-color: black; }
        .ansi-bg-red { background-color: red; }
        .ansi-bg-green { background-color: green; }
        .ansi-bg-yellow { background-color: yellow; }
        .ansi-bg-blue { background-color: blue; }
        .ansi-bg-magenta { background-color: magenta; }
        .ansi-bg-cyan { background-color: cyan; }
        .ansi-bg-white { background-color: white; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 连接区域 -->
        <div class="connection-panel">
            <div class="connection-left">
                <label>过滤:</label>
                <input type="text" id="deviceNameFilter" placeholder="蓝牙名称过滤" value="Pet_">
                <div class="status-info">
                    <span id="connectionStatus">未连接</span>
                    <span id="connectedDevice"></span>
                </div>
            </div>
            <div class="connection-right">
                <button id="connectBtn" class="connect-btn">连接</button>
                <button id="disconnectBtn" class="disconnect-btn" style="display: none;">断开</button>
            </div>
        </div>

        <!-- 接收区域 -->
        <div class="receive-panel">
            <div class="receive-header">
                <span id="receivedBytes">接收: 0</span>
                <div class="receive-controls">
                    <div class="checkbox-container">
                        <input type="checkbox" id="hexDisplay">
                        <label for="hexDisplay">HEX</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="autoReconnect" checked>
                        <label for="autoReconnect">自动重连</label>
                    </div>
                    <button id="clearBtn" class="clear-btn">清除</button>
                </div>
            </div>
            <div id="receiveOutput" class="receive-output"></div>
        </div>

        <!-- 发送区域 -->
        <div class="send-panel">
            <input type="text" id="sendInput" class="send-input" placeholder="输入要发送的数据...">
            <div class="checkbox-container">
                <input type="checkbox" id="hexSend">
                <label for="hexSend">HEX</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="sendNewline" checked>
                <label for="sendNewline">发送换行</label>
            </div>
            <button id="sendBtn" class="send-btn" disabled>发送</button>
        </div>

        <!-- 自定义按键区域 -->
        <div class="custom-buttons-panel">
            <button id="btnTracker" class="custom-btn" disabled>Tracker状态</button>
            <button id="btnBattery" class="custom-btn" disabled>电量</button>
            <button id="btnMotion" class="custom-btn" disabled>运动状态</button>
            <button id="btnWifiZone" class="custom-btn" disabled>WiFi-Zone</button>
            <button id="btnFence" class="custom-btn" disabled>围栏</button>
        </div>
    </div>

    <!-- <script src="bluetooth.js"></script> -->
</body>

<script>
    // 蓝牙串口调试工具主程序
    class BluetoothSerialDebugger {
        constructor() {
            this.device = null;
            this.server = null;
            this.receiveCharacteristic = null;
            this.sendCharacteristic = null;
            this.isConnected = false;
            this.receivedBytes = 0;
            this.autoReconnectEnabled = false;
            this.reconnectTimer = null;
            
            // 性能优化相关
            this.receiveBuffer = []; // 数据缓冲区
            this.bufferSize = 0; // 缓冲区大小
            this.maxDisplaySize = 500 * 1024; // 最大显示数据量（500KB）
            this.updateInterval = 100; // 更新间隔（毫秒）
            this.updateTimer = null; // 更新定时器
            this.pendingContent = ''; // 待显示内容
            
            // 服务UUID配置
            this.services = [
                {
                    uuid: '0000d0d0-0000-1000-8000-00805f9b34fb',
                    sendCharUuid: '0000d0d1-0000-1000-8000-00805f9b34fb',
                    receiveCharUuid: '0000d0d2-0000-1000-8000-00805f9b34fb'
                },
                {
                    uuid: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
                    sendCharUuid: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
                    receiveCharUuid: '6e400005-b5a3-f393-e0a9-e50e24dcca9e'
                }
            ];
            
            this.initElements();
            this.bindEvents();
        }
        
        initElements() {
            this.elements = {
                deviceNameFilter: document.getElementById('deviceNameFilter'),
                connectionStatus: document.getElementById('connectionStatus'),
                connectedDevice: document.getElementById('connectedDevice'),
                autoReconnect: document.getElementById('autoReconnect'),
                connectBtn: document.getElementById('connectBtn'),
                disconnectBtn: document.getElementById('disconnectBtn'),
                receiveOutput: document.getElementById('receiveOutput'),
                hexDisplay: document.getElementById('hexDisplay'),
                receivedBytes: document.getElementById('receivedBytes'),
                clearBtn: document.getElementById('clearBtn'),
                sendInput: document.getElementById('sendInput'),
                hexSend: document.getElementById('hexSend'),
                sendNewline: document.getElementById('sendNewline'),
                sendBtn: document.getElementById('sendBtn'),
                // 自定义按键
                btnTracker: document.getElementById('btnTracker'),
                btnBattery: document.getElementById('btnBattery'),
                btnMotion: document.getElementById('btnMotion'),
                btnWifiZone: document.getElementById('btnWifiZone'),
                btnFence: document.getElementById('btnFence'),
            };
        }
        
        bindEvents() {
            this.elements.connectBtn.addEventListener('click', () => this.connect());
            this.elements.disconnectBtn.addEventListener('click', () => this.disconnect());
            this.elements.clearBtn.addEventListener('click', () => this.clearOutput());
            this.elements.sendBtn.addEventListener('click', () => this.sendData());
            this.elements.sendInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendData();
                }
            });

            // 自定义按键事件
            this.elements.btnTracker.addEventListener('click', () => this.sendCustomCommand('tracker'));
            this.elements.btnBattery.addEventListener('click', () => this.sendCustomCommand('adc'));
            this.elements.btnMotion.addEventListener('click', () => this.sendCustomCommand('gsensor snapshot'));
            this.elements.btnWifiZone.addEventListener('click', () => this.sendCustomCommand('wifizone'));
            this.elements.btnFence.addEventListener('click', () => this.sendCustomCommand('fence'));

            this.elements.hexDisplay.addEventListener('change', () => this.refreshDisplay());
            this.elements.autoReconnect.addEventListener('change', (e) => {
                this.autoReconnectEnabled = e.target.checked;
            });
        }

        sendCustomCommand(command) {
            if (!this.isConnected || !this.sendCharacteristic) {
                console.warn('设备未连接，无法发送命令');
                return;
            }

            try {
                let data = command + '\n';
                
                if (this.elements.hexSend.checked) {
                    // HEX模式发送
                    const hexArray = data.split('').map(char => char.charCodeAt(0).toString(16).padStart(2, '0'));
                    data = hexArray.join(' ');
                }

                const encoder = new TextEncoder();
                const buffer = encoder.encode(data);
                
                this.sendCharacteristic.writeValue(buffer)
                    .then(() => {
                        console.log(`发送自定义命令成功: ${command}`);
                    })
                    .catch(error => {
                        console.error('发送自定义命令失败:', error);
                        this.handleBluetoothError('发送失败', error);
                    });
            } catch (error) {
                console.error('发送自定义命令错误:', error);
                this.handleBluetoothError('发送错误', error);
            }
        }

        async handleBluetoothError(error) {
            // this.updateStatus('连接失败: ' + error.message);
            // alert('连接失败: ' + error.message);
            console.log(error)
            // this is so fucking ugly but i have no choice
            // you would never know how those shitty browsers behave
            if (error.toString().match(/User cancelled/) || error.toString() == "2") return; // "2" is a weird behavior of Bluefy browser on iOS
            const dialogContent = document.getElementById("dialog-content");
            if (!navigator.bluetooth || error.toString().match(/Bluetooth adapter not available/)) {
                dialogContent.innerText = "找不到蓝牙硬件，或浏览器不支持。\n\n限于篇幅，详情请参考源代码仓库内的“疑难解答”。";
            } else if (error.toString().match(/User denied the browser permission/)) {
                dialogContent.innerText = "蓝牙权限遭拒。\n\n请前往手机设置，授予浏览器“位置信息”权限。\n此权限不会用于定位，详情请参考源代码仓库内的“疑难解答”。";
            } else if (error.toString().match(/NetworkError/)) {
                dialogContent.innerText = "连接不稳定，无法与蓝牙设备建立连接。\n请重试。";
            } else {
                dialogContent.innerText = error + "\n\n是什么呢\n\n（这可能是一个Bug，请截图并反馈给开发者。）";
            }
            document.getElementById("dialog").showModal();
            if (bluetoothDevice) await bluetoothDevice.gatt.disconnect();
            isStarted = false;
        }

        async connect() {
            try {
                this.updateStatus('正在搜索设备...');
                
                // 请求蓝牙设备
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{
                        namePrefix: this.elements.deviceNameFilter.value || 'Pet_'
                    }],
                    optionalServices: this.services.map(s => s.uuid)
                });
                
                this.device = device;
                this.updateStatus('正在连接...');
                
                // 连接GATT服务器
                this.server = await device.gatt.connect();
                
                // 尝试连接优先服务
                let connectedService = null;
                for (const serviceConfig of this.services) {
                    try {
                        const service = await this.server.getPrimaryService(serviceConfig.uuid);
                        connectedService = serviceConfig;
                        
                        // 获取特征值
                        this.receiveCharacteristic = await service.getCharacteristic(serviceConfig.receiveCharUuid);
                        this.sendCharacteristic = await service.getCharacteristic(serviceConfig.sendCharUuid);
                        
                        // 启用通知
                        await this.receiveCharacteristic.startNotifications();
                        this.receiveCharacteristic.addEventListener('characteristicvaluechanged', 
                            (e) => this.handleReceive(e));
                        
                        break;
                    } catch (error) {
                        console.log(`服务 ${serviceConfig.uuid} 连接失败:`, error);
                        continue;
                    }
                }
                
                if (!connectedService) {
                    throw new Error('无法连接到任何已知服务');
                }
                
                this.isConnected = true;
                this.updateUI();
                this.updateStatus('已连接', device.name);
                
                // 监听设备断开
                device.addEventListener('gattserverdisconnected', () => {
                    this.handleDisconnect();
                });
                
            } catch (error) {
                await this.handleBluetoothError(error);
            }
        }
        
        async disconnect() {
            if (this.device && this.device.gatt.connected) {
                await this.device.gatt.disconnect();
            }
            this.handleDisconnect();
        }
        
        handleDisconnect() {
            this.isConnected = false;
            this.updateUI();
            this.updateStatus('已断开', this.device.name);
            
            // 自动重连
            if (this.autoReconnectEnabled) {
                this.scheduleReconnect();
            }
        }
        
        scheduleReconnect() {
            if (this.reconnectTimer) {
                clearTimeout(this.reconnectTimer);
            }
            
            this.reconnectTimer = setTimeout(() => {
                if (this.autoReconnectEnabled && !this.isConnected) {
                    this.updateStatus('自动重连中...');
                    this.connect();
                }
            }, 3000);
        }
        
        handleReceive(event) {
            const value = event.target.value;
            const bytes = new Uint8Array(value.buffer);
            
            this.receivedBytes += bytes.length;
            this.elements.receivedBytes.textContent = `接收: ${this.receivedBytes}`;
            
            let content;
            if (this.elements.hexDisplay.checked) {
                // HEX显示
                const hexString = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
                content = hexString + ' ';
            } else {
                // UTF-8显示
                const text = new TextDecoder('utf-8').decode(bytes);
                content = this.processAnsiColors(text);
            }
            
            // 添加到缓冲区
            this.pendingContent += content;
            this.scheduleUpdate();
        }
        
        scheduleUpdate() {
            if (!this.updateTimer) {
                this.updateTimer = setTimeout(() => {
                    this.flushBuffer();
                    this.updateTimer = null;
                }, this.updateInterval);
            }
        }
        
        flushBuffer() {
            if (!this.pendingContent) return;
            
            const output = this.elements.receiveOutput;
            const isAtBottom = output.scrollTop >= output.scrollHeight - output.clientHeight - 10;
            
            // 性能优化：限制最大显示内容
            const currentContent = output.innerHTML;
            const currentSize = new Blob([currentContent]).size;
            const newContentSize = new Blob([this.pendingContent]).size;
            
            if (currentSize + newContentSize > this.maxDisplaySize) {
                // 删除旧内容（保留最后80%的内容）
                const lines = currentContent.split('\n');
                const linesToKeep = Math.floor(lines.length * 0.8);
                output.innerHTML = lines.slice(-linesToKeep).join('\n');
            }
            
            // 批量添加新内容
            output.innerHTML += this.pendingContent;
            this.pendingContent = '';
            
            // 保持滚动到底部
            if (isAtBottom) {
                output.scrollTop = output.scrollHeight;
            }
        }
        
        processAnsiColors(text) {
            try {
                let result = text;
                
                // 处理复杂格式如 \x1b[1;31m (粗体+红色)
                const complexPattern = /\x1b\[(\d+);(\d+)m/g;
                result = result.replace(complexPattern, (match, styleCode, colorCode) => {
                    const colorMap = {
                        '30': 'ansi-black',
                        '31': 'ansi-red', 
                        '32': 'ansi-green',
                        '33': 'ansi-yellow',
                        '34': 'ansi-blue',
                        '35': 'ansi-magenta',
                        '36': 'ansi-cyan',
                        '37': 'ansi-white'
                    };
                    
                    const colorClass = colorMap[colorCode];
                    if (colorClass) {
                        if (styleCode === '1') {
                            return `<span class="${colorClass} ansi-bold">`;
                        }
                        return `<span class="${colorClass}">`;
                    }
                    return match;
                });
                
                // 处理简单颜色格式
                const simpleColorMap = {
                    '\x1b[30m': '<span class="ansi-black">',
                    '\x1b[31m': '<span class="ansi-red">',
                    '\x1b[32m': '<span class="ansi-green">',
                    '\x1b[33m': '<span class="ansi-yellow">',
                    '\x1b[34m': '<span class="ansi-blue">',
                    '\x1b[35m': '<span class="ansi-magenta">',
                    '\x1b[36m': '<span class="ansi-cyan">',
                    '\x1b[37m': '<span class="ansi-white">',
                    '\x1b[0m': '</span>',
                    '\x1b[1m': '<span class="ansi-bold">'
                };
                
                for (const [ansiCode, htmlTag] of Object.entries(simpleColorMap)) {
                    result = result.split(ansiCode).join(htmlTag);
                }
                
                return result;
            } catch (error) {
                console.warn('ANSI颜色处理失败:', error);
                return text;
            }
        }
        
        appendOutput(content) {
            const output = this.elements.receiveOutput;
            const isAtBottom = output.scrollTop >= output.scrollHeight - output.clientHeight - 10;
            
            // 调试：检查内容中是否包含ANSI转义字符
            if (content.includes('\x1b[')) {
                console.log('检测到ANSI转义字符:', content);
                // 显示原始内容和处理后的内容对比
                const processed = this.processAnsiColors(content);
                console.log('原始内容:', JSON.stringify(content));
                console.log('处理后内容:', processed);
            }
            
            output.innerHTML += content;
            
            // 保持滚动到底部
            if (isAtBottom) {
                output.scrollTop = output.scrollHeight;
            }
        }
        
        async sendData() {
            if (!this.isConnected || !this.sendCharacteristic) {
                return;
            }
            
            const input = this.elements.sendInput.value.trim();
            if (!input) return;
            
            try {
                let data;
                if (this.elements.hexSend.checked) {
                    // HEX发送
                    const hexString = input.replace(/\\s/g, '');
                    if (!/^[0-9a-fA-F]*$/.test(hexString)) {
                        alert('HEX格式错误');
                        return;
                    }
                    data = new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                } else {
                    // 文本发送
                    let text = input;
                    if (this.elements.sendNewline.checked) {
                        text += '\n';
                    }
                    data = new TextEncoder().encode(text);
                }
                
                await this.sendCharacteristic.writeValue(data);
                // this.elements.sendInput.value = '';
                
            } catch (error) {
                console.error('发送失败:', error);
                alert('发送失败: ' + error.message);
            }
        }
        
        clearOutput() {
            this.elements.receiveOutput.innerHTML = '';
            this.receivedBytes = 0;
            this.elements.receivedBytes.textContent = '接收: 0';
            this.pendingContent = ''; // 清空缓冲区
            if (this.updateTimer) {
                clearTimeout(this.updateTimer);
                this.updateTimer = null;
            }
        }
        
        // 添加页面卸载时的清理
        cleanup() {
            if (this.updateTimer) {
                clearTimeout(this.updateTimer);
            }
            if (this.reconnectTimer) {
                clearTimeout(this.reconnectTimer);
            }
        }
        
        refreshDisplay() {
            // 切换显示模式时重新显示已有内容
            // 这里可以实现更复杂的逻辑
        }
        
        updateStatus(status, deviceName = '') {
            this.elements.connectionStatus.textContent = status;
            if (deviceName) {
                this.elements.connectedDevice.textContent = ` : ${deviceName}`;
            } else {
                this.elements.connectedDevice.textContent = '';
            }
        }
        
        updateUI() {
            if (this.isConnected) {
                this.elements.connectBtn.style.display = 'none';
                this.elements.disconnectBtn.style.display = 'block';
                this.elements.sendBtn.disabled = false;
            } else {
                this.elements.connectBtn.style.display = 'block';
                this.elements.disconnectBtn.style.display = 'none';
                this.elements.sendBtn.disabled = true;
            }

            // 更新自定义按键状态
            this.elements.btnTracker.disabled = !this.isConnected;
            this.elements.btnBattery.disabled = !this.isConnected;
            this.elements.btnMotion.disabled = !this.isConnected;
            this.elements.btnWifiZone.disabled = !this.isConnected;
            this.elements.btnFence.disabled = !this.isConnected;
        }
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', () => {
        // 检查浏览器支持
        if (!navigator.bluetooth) {
            alert('您的浏览器不支持Web Bluetooth API，请使用Chrome、Edge或Opera浏览器。');
            return;
        }
        
        new BluetoothSerialDebugger();
    });
</script>

</html>
